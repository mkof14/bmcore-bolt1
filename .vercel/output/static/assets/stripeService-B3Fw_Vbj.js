import{stripeConfig as r,validateStripeConfig as e}from"./stripe-DOzrBqlG.js";import{s as t}from"./index-D6X-thcP.js";import"./react-vendor-Dq_i0H7_.js";import"./supabase-D2F8Vsqq.js";let n=null;function o(){if(!e())throw new Error("Stripe configuration is invalid");if("undefined"==typeof window||!window.Stripe)throw new Error("Stripe.js not loaded. Make sure Stripe script is included in index.html");return n=window.Stripe(r.publishableKey),n}function i(){return n||(n=o()),n}async function s(r,e){try{const{data:{session:o}}=await t.auth.getSession();if(!o)throw new Error("Not authenticated");let i=window.location.origin;i.includes("webcontainer")||i.includes("localhost");const s=`${i}/member-zone?payment=success`,a=`${i}/pricing?payment=cancelled`,c=await t.functions.invoke("create-checkout-session",{body:{priceId:r,userId:e,successUrl:s,cancelUrl:a},headers:{Authorization:`Bearer ${o.access_token}`}}),{data:d,error:u}=c;if(u){let r="";try{if(u.context&&u.context instanceof Response){const e=u.context.clone(),t=await e.text();try{const e=JSON.parse(t);r=e.error||e.message||t}catch{r=t}}}catch(n){}if(d)throw new Error(`Edge Function Error: ${d.error||r||u.message||"Unknown error"}`);throw new Error(`Edge Function Error: ${r||u.message||"Unknown error"}`)}if(!d)throw new Error("No data returned from Edge Function");if(d.error)throw new Error(`Edge Function Error: ${d.error}`);if(!d.sessionId&&!d.url)throw new Error(`Invalid response: ${JSON.stringify(d)}`);return{sessionId:d.sessionId,url:d.url}}catch(o){throw o}}async function a(e,n="monthly"){var o,a;try{const{data:{user:o}}=await t.auth.getUser();if(!o)throw new Error("User not authenticated");const a=r.prices[e];if(!a)throw new Error(`Invalid plan: ${e}`);const d=a[n].priceId,u=i(),{sessionId:w,url:l}=await s(d,o.id);if(l&&l.length>0){try{(window.top||window).location.href=l}catch(c){setTimeout(()=>{window.location.replace(l)},100)}return new Promise(()=>{})}const{error:h}=await u.redirectToCheckout({sessionId:w});if(h)throw h}catch(d){throw(null==(o=d.message)?void 0:o.includes("Missing authorization"))?new Error("Authentication required. Please sign in and try again."):(null==(a=d.message)?void 0:a.includes("Missing required environment variables"))?new Error("Payment system not configured. Please contact support."):new Error(d.message||"Failed to start checkout. Please try again.")}}async function c(){try{const{data:{session:r}}=await t.auth.getSession();if(!r)throw new Error("Not authenticated");const{data:e,error:n}=await t.functions.invoke("create-portal-session",{headers:{Authorization:`Bearer ${r.access_token}`}});if(n)throw n;return e.url}catch(r){throw r}}export{s as createCheckoutSession,c as createPortalSession,i as getStripe,o as initStripe,a as redirectToCheckout};
