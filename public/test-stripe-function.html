<!DOCTYPE html>
<html>
<head>
    <title>Test Stripe Edge Function</title>
</head>
<body>
    <h1>Stripe Edge Function Test</h1>
    <button onclick="testFunction()">Test Edge Function</button>
    <pre id="output"></pre>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

        const supabaseUrl = 'https://txnwvaqzmtlhefcxilfu.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4bnd2YXF6bXRsaGVmY3hpbGZ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MTUxNDEsImV4cCI6MjA3NjM5MTE0MX0.nvfoPz57lwSgiVJDwbZgwvlTJhsnHtk4nM1M-q2_snA';

        const supabase = createClient(supabaseUrl, supabaseKey);

        window.testFunction = async function() {
            const output = document.getElementById('output');
            output.textContent = 'Testing...\n';

            try {
                // Get current user
                const { data: { user }, error: authError } = await supabase.auth.getUser();

                if (authError || !user) {
                    output.textContent += 'ERROR: Not authenticated. Please sign in first.\n';
                    return;
                }

                output.textContent += `‚úÖ User authenticated: ${user.id}\n\n`;

                // Test Edge Function
                output.textContent += 'Calling Edge Function...\n';

                const { data: { session } } = await supabase.auth.getSession();

                const response = await supabase.functions.invoke('create-checkout-session', {
                    body: {
                        priceId: 'price_1Ry1B0FeT62z7zOTfpYzRVgK', // Core monthly
                        userId: user.id,
                        successUrl: window.location.origin + '/member-zone?payment=success',
                        cancelUrl: window.location.origin + '/pricing?payment=cancelled'
                    },
                    headers: {
                        Authorization: `Bearer ${session.access_token}`
                    }
                });

                output.textContent += '\n=== RESPONSE ===\n';
                output.textContent += JSON.stringify(response, null, 2);

                if (response.error) {
                    output.textContent += '\n\n‚ùå ERROR:\n' + JSON.stringify(response.error, null, 2);
                } else if (response.data) {
                    output.textContent += '\n\n‚úÖ SUCCESS:\n';
                    output.textContent += 'Session ID: ' + response.data.sessionId + '\n';
                    output.textContent += 'Checkout URL: ' + response.data.url + '\n';

                    if (response.data.url) {
                        output.textContent += '\n\nüöÄ Redirecting to Stripe in 3 seconds...';
                        setTimeout(() => {
                            window.location.href = response.data.url;
                        }, 3000);
                    }
                }

            } catch (err) {
                output.textContent += '\n\n‚ùå EXCEPTION:\n' + err.message + '\n';
                output.textContent += err.stack;
            }
        };
    </script>
</body>
</html>
